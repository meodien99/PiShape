<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Canvas</title>
    <script type="text/javascript" src="bower_components/canvas-5-polyfill/canvas.js"></script>
    <style>
        body {
            background-color: #e4e4e4 ;
        }
        #canvas {
            background-color: #fff;
            border: 1px solid #000;
        }
    </style>
</head>
<body>
<!--<canvas id="canvas" width="400" height="400">-->
<!--This text is displayed if your browser does not support HTML5 Canvas.-->
<!--</canvas>-->

<!--<script data-main="js/index" src="node_modules/requirejs/require.js"></script>-->

<script src="js/dat.gui.min.js"></script>
<script src="js/stats.min.js"></script>
<script src="js/three.min.js"></script>
<script src="js/controls/OrbitControls.js"></script>
<script src="js/CopyShader.js"></script>
<script src="js/EffectComposer.js"></script>
<script src="js/RenderPass.js"></script>
<script src="js/ShaderPass.js"></script>
<script src="js/MaskPass.js"></script>
<!--<script src="out.js"></script>-->
<script>
    var scene, camera, renderer, control, stats, cameraControl
            ,cameraBG, sceneBG, composer;

    function init(){
        scene = new THREE.Scene();

        renderer = new THREE.WebGLRenderer();
        renderer.setClearColor(0x000000, 1.0);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;


        //draw shape
        var sphereGeometry = new THREE.SphereGeometry(15, 60, 60);
        var sphereMaterial = createEarthMaterial();
        var earth = new THREE.Mesh(sphereGeometry, sphereMaterial);
        earth.name = 'earth';
        scene.add(earth);

        //cloud geometry
        var cloudGeometry = new THREE.SphereGeometry(15.1,
                                sphereGeometry.parameters.widthSegments, sphereGeometry.parameters.heightSegments);
        var cloudMaterial = createCloudMaterial();
        var cloud = new THREE.Mesh(cloudGeometry, cloudMaterial);
        cloud.name = 'clouds';
        scene.add(cloud);

        var ambientLight = new THREE.AmbientLight(0x111111);
        scene.name = 'ambient';
        scene.add(ambientLight);


        var directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position = new THREE.Vector3(100, 10, -50);
        directionalLight.name = 'directional';
        scene.add(directionalLight);


        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.x = 25;
        camera.position.y = 10;
        camera.position.z = 23;
        camera.lookAt(scene.position);

        //add control
        cameraControl = new THREE.OrbitControls(camera);

        control = new function(){
            this.rotationSpeed = 0.001;
            this.directionalLightColor = directionalLight.color.getHex();
            this.ambientLightColor = ambientLight.color.getHex();
        };

        // add background using a camera
        cameraBG = new THREE.OrthographicCamera(
                -window.innerWidth,
                window.innerWidth,
                window.innerHeight,
                -window.innerHeight,
                -10000, 10000);
        cameraBG.position.z = 50;
        sceneBG = new THREE.Scene();


        var materialColor = new THREE.MeshBasicMaterial({
            map : THREE.ImageUtils.loadTexture('./assets/planets/starry_background.jpg'),
            depthTest : false
        });

        var bgPlane = new THREE.Mesh(new THREE.PlaneGeometry(1, 1), materialColor);
        bgPlane.position.z = -100;
        bgPlane.scale.set(
                window.innerWidth * 2, window.innerHeight * 2, 1
        );
        sceneBG.add(bgPlane);

        //set up the passes
        var bgPass = new THREE.RenderPass(sceneBG, cameraBG);
        var renderPass = new THREE.RenderPass(scene, camera);
        renderPass.clear = false;

        var effectCopy = new THREE.ShaderPass(THREE.CopyShader);
        effectCopy.renderToScreen = true;

        //add these passes to the composer
        composer = new THREE.EffectComposer(renderer);
        composer.addPass(bgPass);
        composer.addPass(renderPass);
        composer.addPass(effectCopy);

        addControlGui(control);
        addStatsObject();

        //append child
        document.body.appendChild(renderer.domElement);
        render();
    }

    function createCloudMaterial(){
        var cloudTexture = THREE.ImageUtils.loadTexture('./assets/planets/fair_clouds_4k.png');
        var cloudMaterial = new THREE.MeshBasicMaterial();
        cloudMaterial.map = cloudTexture;
        cloudMaterial.transparent = true;
        return cloudMaterial;
    }

    function createEarthMaterial(){
        // 4096 is the maximum width for image
        var earthTexture = THREE.ImageUtils.loadTexture("./assets/planets/earthmap4k.jpg");
        var earthMaterial = new THREE.MeshPhongMaterial();
        earthMaterial.map = earthTexture;

        var normalMap = THREE.ImageUtils.loadTexture("./assets/planets/earth_normalmap_flat4l.jpg");
        earthMaterial.normalMap = normalMap;
        earthMaterial.normalScale = new THREE.Vector2(0.5, 0.7);

        var specularMap = THREE.ImageUtils.loadTexture('./assets/planets/earthspec4k.jpg');
        earthMaterial.specularMap = specularMap;
        earthMaterial.specular = new THREE.Color(0x262626);
        return earthMaterial;
    }

    function addStatsObject(){
        stats = new Stats();
        stats.setMode(0);
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.left = '0px';
        stats.domElement.style.top = '0px';
        document.body.appendChild(stats.domElement);
    }

    function addControlGui(controlObject){
        var gui = new dat.GUI();
        gui.add(controlObject, 'rotationSpeed', -0.01, 0.01);
        gui.addColor(controlObject, 'directionalLightColor');
        gui.addColor(controlObject, 'ambientLightColor');
    }

    function render(){
        stats.update();

        //update camera
        cameraControl.update();

        scene.getObjectByName('earth').rotation.y+=control.rotationSpeed;
        scene.getObjectByName('clouds').rotation.y+=control.rotationSpeed*1.1;

        scene.getObjectByName('ambient').color = new THREE.Color(control.ambientLightColor);
        scene.getObjectByName('directional').color = new THREE.Color(control.directionalLightColor);

        renderer.autoClear = false;
        composer.render();
        // render using requestAnimationFrame
//        renderer.render(scene, camera);
        requestAnimationFrame(render);
    }

    window.onload = init;
</script>
</body>
</html>